<!DOCTYPE html>
<html lang="en">
<head>
    <title>All Users List</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-active { color: green; font-weight: bold; }
        .status-blocked { color: red; font-weight: bold; }
        .action-btn { margin-right: 5px; }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark px-3 mb-4">
    <a href="dashboard.html" class="btn btn-outline-light btn-sm">â¬… Back to Home</a>
    <span class="navbar-text text-white">All User Management</span>
</nav>

<div class="container-fluid px-4">
    
    <!-- Search / Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <input type="text" id="searchInput" onkeyup="filterTable()" class="form-control" placeholder="ðŸ” Search by Email or UID...">
        </div>
    </div>

    <!-- Users Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-users"></i> Registered Users List (<span id="totalUsers">0</span>)
        </div>
        <div class="card-body p-0 table-responsive">
            <table class="table table-striped table-hover mb-0" id="userTable">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>User UID</th>
                        <th>Email / Name</th>
                        <th>Balance</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" class="text-center p-3">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Balance Edit Modal -->
<div class="modal fade" id="balanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUid">
                <p>User: <span id="editEmail" class="fw-bold"></span></p>
                <p>Current Balance: <span id="currentBalDisplay"></span></p>
                
                <label>Add or Subtract Amount:</label>
                <input type="number" id="editAmount" class="form-control mb-2" placeholder="Enter amount (e.g. 50)">
                
                <div class="d-flex gap-2">
                    <button onclick="updateBalance('add')" class="btn btn-success w-50">+ Add</button>
                    <button onclick="updateBalance('sub')" class="btn btn-warning w-50">- Subtract</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS (Required for Modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyA-6c8nN8TUj9V8km-NAVkjgoIeQ5m7_ms",
      authDomain: "art-732d1.firebaseapp.com",
      databaseURL: "https://art-732d1-default-rtdb.firebaseio.com",
      projectId: "art-732d1",
      storageBucket: "art-732d1.firebasestorage.app",
      messagingSenderId: "901862985233",
      appId: "1:901862985233:web:ddfd6b7c8a57c65ef0ebb0"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. Load All Users Automatically
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; // Clear table
        
        let count = 0;

        if(snapshot.exists()) {
            snapshot.forEach((child) => {
                const uid = child.key;
                const data = child.val();
                count++;

                const email = data.email || "No Email";
                const balance = data.balance || 0;
                const isBlocked = data.blocked === true;
                
                // Status HTML
                const statusBadge = isBlocked 
                    ? `<span class="badge bg-danger">BLOCKED</span>` 
                    : `<span class="badge bg-success">Active</span>`;

                // Block/Unblock Button Logic
                const blockBtn = isBlocked
                    ? `<button onclick="toggleBlock('${uid}', false)" class="btn btn-sm btn-outline-success action-btn" title="Unblock"><i class="fas fa-unlock"></i> Unblock</button>`
                    : `<button onclick="toggleBlock('${uid}', true)" class="btn btn-sm btn-outline-danger action-btn" title="Block"><i class="fas fa-ban"></i> Block</button>`;

                // Row HTML
                const row = `
                    <tr>
                        <td>${count}</td>
                        <td><small>${uid}</small></td>
                        <td>${email}</td>
                        <td class="fw-bold text-primary">${balance}</td>
                        <td>${statusBadge}</td>
                        <td class="text-end">
                            <button onclick="openModal('${uid}', '${email}', ${balance})" class="btn btn-sm btn-primary action-btn" data-bs-toggle="modal" data-bs-target="#balanceModal"><i class="fas fa-edit"></i> Edit Bal</button>
                            ${blockBtn}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            document.getElementById('totalUsers').innerText = count;
        } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">No users found in database</td></tr>`;
            document.getElementById('totalUsers').innerText = 0;
        }
    });

    // 2. Open Modal Function
    window.openModal = (uid, email, currentBal) => {
        document.getElementById('editUid').value = uid;
        document.getElementById('editEmail').innerText = email;
        document.getElementById('currentBalDisplay').innerText = currentBal;
        document.getElementById('editAmount').value = ""; // Clear input
    };

    // 3. Update Balance Function
    window.updateBalance = (type) => {
        const uid = document.getElementById('editUid').value;
        const amount = Number(document.getElementById('editAmount').value);
        const currentBal = Number(document.getElementById('currentBalDisplay').innerText);

        if(!amount || amount < 0) return alert("Please enter a valid amount");

        const newBal = type === 'add' ? currentBal + amount : currentBal - amount;

        update(ref(db, 'users/' + uid), {
            balance: newBal
        }).then(() => {
            // Close Modal
            const modalEl = document.getElementById('balanceModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            alert("Balance Updated Successfully!");
        }).catch(err => alert("Error: " + err.message));
    };

    // 4. Block/Unblock Function
    window.toggleBlock = (uid, status) => {
        const action = status ? "BLOCK" : "UNBLOCK";
        if(confirm(`Are you sure you want to ${action} this user?`)) {
            update(ref(db, 'users/' + uid), {
                blocked: status
            }).then(() => {
                // Alert not needed as table updates automatically via onValue
            });
        }
    };

    // 5. Search / Filter Function (JavaScript Filter)
    window.filterTable = () => {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("userTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header
            let tdUid = tr[i].getElementsByTagName("td")[1]; // UID column
            let tdEmail = tr[i].getElementsByTagName("td")[2]; // Email column
            
            if (tdUid || tdEmail) {
                const txtValueUid = tdUid.textContent || tdUid.innerText;
                const txtValueEmail = tdEmail.textContent || tdEmail.innerText;
                
                if (txtValueUid.toUpperCase().indexOf(filter) > -1 || txtValueEmail.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }       
        }
    };

</script>

</body>
</html>
